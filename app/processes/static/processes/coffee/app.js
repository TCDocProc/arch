// Generated by CoffeeScript 1.9.0
(function() {
  var __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    __hasProp = {}.hasOwnProperty;

  jQuery(function() {
    var Action, ActionView, AppRouter, Branch, BranchView, MinimapView, PageView, Process, Processes, ProcessesView, Sequence, SequenceView, app_router, ss, view;
    Action = (function(_super) {
      __extends(Action, _super);

      function Action() {
        return Action.__super__.constructor.apply(this, arguments);
      }

      Action.prototype.getRelativeActivePaths = function() {
        if (this.get('state') === 'ACTIVE') {
          return [""];
        } else {
          return [];
        }
      };

      return Action;

    })(Backbone.Model);
    Branch = (function(_super) {
      __extends(Branch, _super);

      function Branch() {
        return Branch.__super__.constructor.apply(this, arguments);
      }

      Branch.prototype.initialize = function(data) {
        var seqs;
        seqs = [];
        _.each(data.sequences, (function(_this) {
          return function(seq, i) {
            var s;
            s = new Sequence(seq);
            s.i = i;
            return seqs.push(s);
          };
        })(this));
        return this.set('seqs', seqs);
      };

      Branch.prototype.getRelativeActivePaths = function() {
        return this.get('seqs').map(function(x, i) {
          return x.getRelativeActivePaths().map(function(y) {
            return i + "/" + y;
          });
        }).reduce(function(x, y) {
          return x.concat(y);
        });
      };

      return Branch;

    })(Backbone.Model);
    Sequence = (function(_super) {
      __extends(Sequence, _super);

      function Sequence() {
        return Sequence.__super__.constructor.apply(this, arguments);
      }

      Sequence.prototype.initialize = function(data) {
        var objs;
        objs = [];
        _.each(data, (function(_this) {
          return function(obj, i) {
            var a, b;
            if (obj.type === "action") {
              a = new Action(obj);
              a.i = i;
              return objs.push(a);
            } else if (obj.type === "branch") {
              b = new Branch(obj);
              b.i = i;
              return objs.push(b);
            }
          };
        })(this));
        return this.set('objs', objs);
      };

      Sequence.prototype.getRelativeActivePaths = function() {
        return this.get('objs').map(function(x, i) {
          return x.getRelativeActivePaths().map(function(y) {
            return i + "/" + y;
          });
        }).reduce(function(x, y) {
          return x.concat(y);
        });
      };

      return Sequence;

    })(Backbone.Model);
    Process = (function(_super) {
      __extends(Process, _super);

      function Process() {
        return Process.__super__.constructor.apply(this, arguments);
      }

      Process.prototype.getRelativeActivePaths = function() {
        return this.get('sequence').getRelativeActivePaths();
      };

      return Process;

    })(Backbone.Model);
    Processes = (function(_super) {
      __extends(Processes, _super);

      function Processes() {
        return Processes.__super__.constructor.apply(this, arguments);
      }

      Processes.prototype.model = Process;

      Processes.prototype.url = function() {
        return "/processes/user/" + this.user_id + ".json";
      };

      Processes.prototype.initialize = function(user_id) {
        this.user_id = user_id;
        return this;
      };

      Processes.prototype.parse = function(response) {
        _.each(response, function(process, i) {
          var s;
          s = new Sequence(process.sequence);
          s.i = i;
          process.sequence = s;
          return process.i = i;
        });
        return response;
      };

      Processes.prototype.getRelativeActivePaths = function() {
        return this.models.map(function(x, i) {
          return x.getRelativeActivePaths().map(function(y) {
            return "/" + i + "/" + y;
          });
        }).reduce(function(x, y) {
          return x.concat(y);
        });
      };

      return Processes;

    })(Backbone.Collection);
    ActionView = (function(_super) {
      __extends(ActionView, _super);

      function ActionView() {
        return ActionView.__super__.constructor.apply(this, arguments);
      }

      ActionView.prototype.attributes = {
        "class": "cell action"
      };

      ActionView.prototype.setup = function(siblingCount) {
        return $(this.el).addClass("siblings-" + siblingCount);
      };

      ActionView.prototype.render = function() {
        $(this.el).addClass(this.model.get('state'));
        $(this.el).html(("<h1> " + (this.model.get("name")) + " </h1>") + ("<p> " + (this.model.get("info")) + " </p>") + ("<p> STATUS: " + (this.model.get("state")) + " </p>"));
        return this;
      };

      ActionView.prototype.moveToPath = function(path) {
        if ((_.first(path) != null) && _.first(path) !== this.model.i) {
          return $(this.el).hide();
        } else {
          return $(this.el).show();
        }
      };

      return ActionView;

    })(Backbone.View);
    BranchView = (function(_super) {
      __extends(BranchView, _super);

      function BranchView() {
        return BranchView.__super__.constructor.apply(this, arguments);
      }

      BranchView.prototype.attributes = {
        "class": "cell branch"
      };

      BranchView.prototype.setup = function(siblingCount) {
        $(this.el).addClass("siblings-" + siblingCount);
        $(this.el).addClass("children-" + (this.model.get("seqs").length));
        return $(this.el).click((function(_this) {
          return function() {
            if ($(_this.el).parent().hasClass('fill') && !$(_this.el).hasClass("focused")) {
              return Backbone.history.navigate((Backbone.history.fragment.match(/.*[^\/]/g)) + "/" + _this.model.i, true);
            }
          };
        })(this));
      };

      BranchView.prototype.render = function() {
        this.childViews = [];
        _.each(this.model.get('seqs'), (function(_this) {
          return function(seq) {
            var seqView;
            seqView = new SequenceView({
              model: seq
            });
            seqView.setup(_this.model.get('seqs').length);
            $(_this.el).append(seqView.render().$el);
            return _this.childViews.push(seqView);
          };
        })(this));
        return this;
      };

      BranchView.prototype.moveToPath = function(path) {
        var passToChildren;
        passToChildren = (function(_this) {
          return function() {
            return _this.childViews.map(function(view) {
              var nextPath;
              nextPath = void 0;
              if (path != null) {
                nextPath = _.tail(path);
              }
              return view.moveToPath(nextPath);
            });
          };
        })(this);
        if (_.first(path) != null) {
          if (_.first(path) === this.model.i) {
            $(this.el).addClass("focused");
            $(this.el).addClass("remove-width");
            return passToChildren();
          } else {
            return $(this.el).hide();
          }
        } else {
          $(this.el).removeClass("remove-width");
          $(this.el).removeClass("focused");
          $(this.el).show();
          return passToChildren();
        }
      };

      return BranchView;

    })(Backbone.View);
    SequenceView = (function(_super) {
      __extends(SequenceView, _super);

      function SequenceView() {
        return SequenceView.__super__.constructor.apply(this, arguments);
      }

      SequenceView.prototype.attributes = {
        "class": "sequence"
      };

      SequenceView.prototype.visible = true;

      SequenceView.prototype.setup = function(siblingCount, header) {
        $(this.el).addClass("siblings-" + siblingCount);
        $(this.el).addClass("children-" + (this.model.get("objs").length));
        if (header !== void 0) {
          $(this.el).prepend("<h1>" + header + "</h1>");
        }
        return $(this.el).click((function(_this) {
          return function() {
            if ($(_this.el).parent().hasClass('focused') && !$(_this.el).hasClass("fill")) {
              return Backbone.history.navigate((Backbone.history.fragment.match(/.*[^\/]/g)) + "/" + _this.model.i, true);
            }
          };
        })(this));
      };

      SequenceView.prototype.render = function() {
        this.childViews = [];
        _.each(this.model.get("objs"), (function(_this) {
          return function(obj) {
            var actionView, branchView;
            switch (obj.get("type")) {
              case "action":
                actionView = new ActionView({
                  model: obj
                });
                actionView.setup(_this.model.get("objs").length);
                $(_this.el).append(actionView.render().$el);
                return _this.childViews.push(actionView);
              case "branch":
                branchView = new BranchView({
                  model: obj
                });
                branchView.setup(_this.model.get("objs").length);
                $(_this.el).append(branchView.render().$el);
                return _this.childViews.push(branchView);
            }
          };
        })(this));
        return this;
      };

      SequenceView.prototype.moveToPath = function(path) {
        var passToChildren;
        passToChildren = (function(_this) {
          return function() {
            return _this.childViews.map(function(cell) {
              var nextPath;
              nextPath = void 0;
              if (path != null) {
                nextPath = _.tail(path);
              }
              return cell.moveToPath(nextPath);
            });
          };
        })(this);
        if (_.first(path) != null) {
          if (_.first(path) === this.model.i) {
            $(this.el).addClass("fill");
            $(this.el).children('.action').children('p').show();
            return passToChildren();
          } else {
            return $(this.el).hide();
          }
        } else {
          $(this.el).children('.action').children('p').hide();
          $(this.el).removeClass("fill");
          $(this.el).show();
          return passToChildren();
        }
      };

      return SequenceView;

    })(Backbone.View);
    ProcessesView = (function(_super) {
      __extends(ProcessesView, _super);

      function ProcessesView() {
        return ProcessesView.__super__.constructor.apply(this, arguments);
      }

      ProcessesView.prototype.attributes = {
        "class": "cell branch focused remove-width"
      };

      ProcessesView.prototype.initialize = function(collection) {
        this.collection = collection;
        return this;
      };

      ProcessesView.prototype.render = function() {
        this.childViews = [];
        $(this.el).addClass("children-" + this.collection.models.length);
        _.each(this.collection.models, (function(_this) {
          return function(proc) {
            var processView, seq;
            seq = proc.get('sequence');
            processView = new SequenceView({
              model: seq
            });
            processView.setup(_this.collection.models.length, proc.get('name'));
            $(_this.el).append(processView.render().$el);
            return _this.childViews.push(processView);
          };
        })(this));
        return this;
      };

      ProcessesView.prototype.moveToPath = function(path) {
        var completion;
        completion = 0;
        return this.childViews.map((function(_this) {
          return function(view) {
            return view.moveToPath(path);
          };
        })(this));
      };

      return ProcessesView;

    })(Backbone.View);
    MinimapView = (function(_super) {
      __extends(MinimapView, _super);

      function MinimapView() {
        return MinimapView.__super__.constructor.apply(this, arguments);
      }

      MinimapView.prototype.el = $('#minimap');

      MinimapView.prototype.initialize = function(collection, user_id) {
        var cv, proc, _i, _len, _ref;
        this.collection = collection;
        this.user_id = user_id;
        this.childViews = (function() {
          var _i, _len, _ref, _results;
          _ref = this.collection.models;
          _results = [];
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            proc = _ref[_i];
            _results.push(new SequenceView({
              model: proc.get('sequence')
            }));
          }
          return _results;
        }).call(this);
        _ref = this.childViews;
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          cv = _ref[_i];
          cv.setup(1);
        }
        this.selectedNode = void 0;
        return this;
      };

      MinimapView.prototype.render = function(callback) {
        var cv, _i, _len, _ref;
        _ref = this.childViews;
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          cv = _ref[_i];
          $(this.el).append(cv.render().$el);
        }
        return this;
      };

      MinimapView.prototype.moveToPath = function(path) {
        var cv, i, _i, _j, _len, _len1, _ref, _ref1;
        if (this.selectedNode != null) {
          $(this.selectedNode.el).removeClass('selected');
        }
        $(this.el).find("*").removeClass('darken');
        if (_.first(path) != null) {
          $('.pushy > ul > h1').show();
          $(this.childViews[_.first(path)].el).show();
          $(this.el).click((function(_this) {
            return function() {
              return Backbone.history.navigate("/processes/user/" + _this.user_id + "/" + (_.first(path)), true);
            };
          })(this));
          this.selectedNode = this.childViews[_.first(path)];
          _ref = _.rest(path);
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            i = _ref[_i];
            this.selectedNode = this.selectedNode.childViews[i];
            $(this.selectedNode.el).siblings().addClass('darken');
          }
          return $(this.selectedNode.el).addClass('selected');
        } else {
          $(this.el).unbind('click');
          _ref1 = this.childViews;
          for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
            cv = _ref1[_j];
            $(cv.el).hide();
          }
          return $('.pushy > ul > h1').hide();
        }
      };

      return MinimapView;

    })(Backbone.View);
    PageView = (function(_super) {
      __extends(PageView, _super);

      function PageView() {
        return PageView.__super__.constructor.apply(this, arguments);
      }

      PageView.prototype.el = '.content';

      PageView.prototype.initialize = function(user_id) {
        this.user_id = user_id;
        $('ul.title-area > :nth-child(1)').click((function(_this) {
          return function() {
            return Backbone.history.navigate("/processes/user/" + _this.user_id, true);
          };
        })(this));
        return this;
      };

      PageView.prototype.render = function(callback) {
        this.collection = new Processes(this.user_id);
        this.collection.fetch({
          success: (function(_this) {
            return function() {
              _this.procView = new ProcessesView(_this.collection);
              $(_this.el).html(_this.procView.render().$el);
              _this.minimap = new MinimapView(_this.collection, _this.user_id);
              _this.minimap.render();
              return callback();
            };
          })(this)
        });
        return this;
      };

      PageView.prototype.moveToPath = function(path) {
        var navClick, p, pathArray, _ref;
        navClick = (function(_this) {
          return function(path) {
            return Backbone.history.navigate("/processes/user/" + _this.user_id + "/" + (path.join('/')), true);
          };
        })(this);
        if ((_ref = $('ul.title-area > :not(:nth-child(1))')) != null) {
          _ref.remove();
        }
        pathArray = path != null ? path.split("/").map(Number) : void 0;
        if (pathArray != null) {
          pathArray.forEach((function(_this) {
            return function(e, i) {
              if (i === 0) {
                $('ul.title-area').append("<li class='name'><h1>&#10095;</h1></li><li class='name'><h1><a>" + $(".content > .branch").children().eq(e).children("h1").text() + "</a></h1></li>");
              } else {
                $('ul.title-area').append("<li class='name'><h1>&#10095;</h1></li><li class='name'><h1><a>...</a></h1></li>");
              }
              return $('ul.title-area').children(":last-child").click(function() {
                return navClick(_.first(pathArray, i + 1));
              });
            };
          })(this));
        }
        $("#go-to-active").html("");
        if (_.first(path) != null) {
          p = _.first(this.collection.get(_.first(path)).getRelativeActivePaths());
          if (p != null) {
            $("#go-to-active").append("<button class='button' style='width:100%'>Go to active</button>");
            $("#go-to-active > :last-child").click((function(_this) {
              return function() {
                return Backbone.history.navigate("/processes/user/" + _this.user_id + "/" + (_.first(path)) + "/" + p, true);
              };
            })(this));
          }
        }
        this.procView.moveToPath(pathArray);
        return this.minimap.moveToPath(pathArray);
      };

      return PageView;

    })(Backbone.View);
    AppRouter = (function(_super) {
      __extends(AppRouter, _super);

      function AppRouter() {
        return AppRouter.__super__.constructor.apply(this, arguments);
      }

      AppRouter.prototype.routes = {
        "processes/user/:user_id(/*path)": "process"
      };

      return AppRouter;

    })(Backbone.Router);
    app_router = new AppRouter;
    view = void 0;
    app_router.on('route:process', function(user_id, path) {
      if (view != null) {
        return view.moveToPath(path);
      } else {
        view = new PageView(user_id);
        return view.render(function() {
          return view.moveToPath(path);
        });
      }
    });
    Backbone.history.start({
      pushState: true
    });
    window.scrollTo(0, 1);
    ss = _.last(document.styleSheets);
    ss.insertRule(".focused > .sequence { max-width: " + ($(window).width() - 80) + "px; max-height: " + ($(window).height() - 100) + "px; }", ss.cssRules.length);
    ss.insertRule(".sequence.fill { max-width: " + ($(window).width() - 20) + "px }", ss.cssRules.length);
    return $(window).resize(function() {
      ss = _.last(document.styleSheets);
      ss.deleteRule(ss.cssRules.length - 1);
      ss.deleteRule(ss.cssRules.length - 1);
      ss.insertRule(".focused > .sequence { max-width: " + ($(window).width() - 80) + "px; max-height: " + ($(window).height() - 100) + "px; }", ss.cssRules.length);
      return ss.insertRule(".sequence.fill { max-width: " + ($(window).width() - 20) + "px }", ss.cssRules.length);
    });
  });

}).call(this);
